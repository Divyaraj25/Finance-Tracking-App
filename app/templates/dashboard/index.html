<!-- app/templates/dashboard/index.html -->
{% extends "base.html" %} {% block title %}Dashboard - {{ super() }}{% endblock
%} {% block content %}
<div class="dashboard">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">
      <i class="bi bi-speedometer2 text-primary"></i> Financial Dashboard
    </h1>
    <div class="btn-group">
      <button
        type="button"
        class="btn btn-outline-primary"
        onclick="refreshDashboard()"
      >
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
      <button
        type="button"
        class="btn btn-outline-secondary"
        data-bs-toggle="collapse"
        data-bs-target="#filtersSection"
      >
        <i class="bi bi-funnel"></i> Filters
      </button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="collapse show" id="filtersSection">
    <div class="card mb-4 filter-card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Date Range</label>
            <input
              type="text"
              class="form-control"
              id="dateRange"
              placeholder="Select date range"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label">Account</label>
            <select class="form-select" id="accountFilter">
              <option value="">All Accounts</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Category</label>
            <select class="form-select" id="categoryFilter">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Transaction Type</label>
            <select class="form-select" id="typeFilter">
              <option value="">All Types</option>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
              <option value="transfer">Transfer</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="applyFilters()">
              <i class="bi bi-search"></i> Apply Filters
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
      <div class="card summary-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-2">Total Balance</h6>
              <h2 class="mb-0" id="totalBalance">$0.00</h2>
              <small class="text-success" id="balanceChange">
                <i class="bi bi-arrow-up"></i> 0%
              </small>
            </div>
            <div class="icon-shape bg-primary bg-opacity-10">
              <i class="bi bi-wallet2 text-primary fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card summary-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-2">Monthly Income</h6>
              <h2 class="mb-0" id="monthlyIncome">$0.00</h2>
              <small class="text-muted">vs last month</small>
            </div>
            <div class="icon-shape bg-success bg-opacity-10">
              <i class="bi bi-graph-up-arrow text-success fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card summary-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-2">Monthly Expense</h6>
              <h2 class="mb-0" id="monthlyExpense">$0.00</h2>
              <small class="text-danger" id="expenseChange">
                <i class="bi bi-arrow-down"></i> 0%
              </small>
            </div>
            <div class="icon-shape bg-danger bg-opacity-10">
              <i class="bi bi-graph-down-arrow text-danger fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card summary-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-2">Budget Status</h6>
              <h2 class="mb-0" id="budgetRemaining">$0.00</h2>
              <small class="text-warning" id="budgetPercent">0% used</small>
            </div>
            <div class="icon-shape bg-warning bg-opacity-10">
              <i class="bi bi-pie-chart text-warning fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-4 mb-4">
    <div class="col-xl-8">
      <div class="card">
        <div class="card-header bg-transparent">
          <h5 class="card-title mb-0">
            <i class="bi bi-bar-chart-line"></i> Income vs Expense Trend
          </h5>
        </div>
        <div class="card-body">
          <div id="trendChart"></div>
        </div>
      </div>
    </div>

    <div class="col-xl-4">
      <div class="card">
        <div class="card-header bg-transparent">
          <h5 class="card-title mb-0">
            <i class="bi bi-pie-chart"></i> Expense Breakdown
          </h5>
        </div>
        <div class="card-body">
          <div id="categoryChart"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Transactions & Account Balances -->
  <div class="row g-4">
    <div class="col-xl-8">
      <div class="card">
        <div
          class="card-header bg-transparent d-flex justify-content-between align-items-center"
        >
          <h5 class="card-title mb-0">
            <i class="bi bi-clock-history"></i> Recent Transactions
          </h5>
          <a
            href="{{ url_for('transactions.index') }}"
            class="btn btn-sm btn-primary"
          >
            View All
          </a>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table
              class="table table-hover align-middle"
              id="recentTransactionsTable"
            >
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Description</th>
                  <th>Category</th>
                  <th>Account</th>
                  <th class="text-end">Amount</th>
                </tr>
              </thead>
              <tbody id="transactionsTableBody">
                <!-- Dynamic content -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-4">
      <div class="card">
        <div class="card-header bg-transparent">
          <h5 class="card-title mb-0">
            <i class="bi bi-pie-chart"></i> Account Distribution
          </h5>
        </div>
        <div class="card-body">
          <div id="accountChart"></div>
          <div class="mt-3" id="accountList">
            <!-- Dynamic account list -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Add Transaction Modal -->
<div class="modal fade" id="quickAddModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Quick Add Transaction
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="quickTransactionForm">
          <div class="mb-3">
            <label class="form-label">Type</label>
            <select class="form-select" name="type" required>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
              <option value="transfer">Transfer</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Amount</label>
            <input
              type="number"
              class="form-control"
              name="amount"
              step="0.01"
              required
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <input
              type="text"
              class="form-control"
              name="description"
              required
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select" name="category_id">
              <option value="">Select Category</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveQuickTransaction()"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Dashboard JavaScript
  let trendChart, categoryChart, accountChart;

  // Initialize dashboard
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize date range picker
    flatpickr("#dateRange", {
      mode: "range",
      dateFormat: "Y-m-d",
      defaultDate: [new Date(new Date().setDate(1)), new Date()],
      onChange: function () {
        applyFilters();
      },
    });

    // Load dashboard data
    loadDashboardData();

    // Load filter options
    loadFilterOptions();
  });

  // Load dashboard data
  function loadDashboardData() {
    const startDate = $("#dateRange").val().split(" to ")[0];
    const endDate = $("#dateRange").val().split(" to ")[1];
    const accountId = $("#accountFilter").val();
    const categoryId = $("#categoryFilter").val();
    const type = $("#typeFilter").val();

    let url = "/dashboard/data";
    const params = new URLSearchParams();
    if (startDate) params.append("start_date", startDate);
    if (endDate) params.append("end_date", endDate);
    if (accountId) params.append("account_id", accountId);
    if (categoryId) params.append("category_id", categoryId);
    if (type) params.append("type", type);

    if (params.toString()) {
      url += "?" + params.toString();
    }

    fetch(url)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          updateSummaryCards(data.data.summary);
          updateTrendChart(data.data.monthly_trend);
          updateCategoryChart(data.data.category_breakdown);
          updateAccountChart(data.data.account_distribution);
          updateRecentTransactions(data.data.recent_transactions);
        }
      })
      .catch((error) => console.error("Error loading dashboard data:", error));
  }

  // Update summary cards
  function updateSummaryCards(summary) {
    document.getElementById("totalBalance").textContent = formatCurrency(
      summary.total_balance
    );
    document.getElementById("monthlyIncome").textContent = formatCurrency(
      summary.total_income
    );
    document.getElementById("monthlyExpense").textContent = formatCurrency(
      summary.total_expense
    );
    document.getElementById("budgetRemaining").textContent = formatCurrency(
      summary.remaining_budget
    );

    const budgetPercent =
      summary.total_budget > 0
        ? ((summary.total_spent / summary.total_budget) * 100).toFixed(1)
        : 0;
    document.getElementById(
      "budgetPercent"
    ).textContent = `${budgetPercent}% used`;
  }

  // Update trend chart
  function updateTrendChart(data) {
    const options = {
      chart: {
        type: "area",
        height: 350,
        toolbar: { show: false },
        zoom: { enabled: false },
      },
      series: [
        {
          name: "Income",
          data: data.map((item) => item.income),
        },
        {
          name: "Expense",
          data: data.map((item) => item.expense),
        },
      ],
      xaxis: {
        categories: data.map((item) => item.month),
      },
      colors: ["#28a745", "#dc3545"],
      fill: {
        type: "gradient",
        gradient: {
          shadeIntensity: 1,
          opacityFrom: 0.7,
          opacityTo: 0.3,
        },
      },
      stroke: {
        curve: "smooth",
        width: 2,
      },
      dataLabels: {
        enabled: false,
      },
      legend: {
        position: "top",
      },
      yaxis: {
        labels: {
          formatter: function (value) {
            return formatCurrency(value);
          },
        },
      },
      tooltip: {
        y: {
          formatter: function (value) {
            return formatCurrency(value);
          },
        },
      },
    };

    if (trendChart) {
      trendChart.updateOptions(options);
    } else {
      trendChart = new ApexCharts(
        document.querySelector("#trendChart"),
        options
      );
      trendChart.render();
    }
  }

  // Update category chart
  function updateCategoryChart(data) {
    const options = {
      chart: {
        type: "pie",
        height: 300,
      },
      series: data.map((item) => item.amount),
      labels: data.map((item) => item.category),
      colors: [
        "#007bff",
        "#28a745",
        "#ffc107",
        "#dc3545",
        "#17a2b8",
        "#6610f2",
      ],
      legend: {
        position: "bottom",
      },
      tooltip: {
        y: {
          formatter: function (value) {
            return formatCurrency(value);
          },
        },
      },
    };

    if (categoryChart) {
      categoryChart.updateOptions(options);
    } else {
      categoryChart = new ApexCharts(
        document.querySelector("#categoryChart"),
        options
      );
      categoryChart.render();
    }
  }

  // Update account chart
  function updateAccountChart(data) {
    const options = {
      chart: {
        type: "donut",
        height: 200,
      },
      series: data.map((item) => item.balance),
      labels: data.map((item) => item.name),
      colors: ["#007bff", "#28a745", "#ffc107", "#17a2b8", "#6610f2"],
      legend: {
        show: false,
      },
      tooltip: {
        y: {
          formatter: function (value) {
            return formatCurrency(value);
          },
        },
      },
    };

    if (accountChart) {
      accountChart.updateOptions(options);
    } else {
      accountChart = new ApexCharts(
        document.querySelector("#accountChart"),
        options
      );
      accountChart.render();
    }

    // Update account list
    const accountList = document.getElementById("accountList");
    accountList.innerHTML = data
      .map(
        (account) => `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span>${account.name}</span>
            <span class="fw-bold">${formatCurrency(account.balance)}</span>
        </div>
    `
      )
      .join("");
  }

  // Update recent transactions
  function updateRecentTransactions(transactions) {
    const tbody = document.getElementById("transactionsTableBody");

    if (transactions.length === 0) {
      tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                    <span class="text-muted">No transactions found</span>
                </td>
            </tr>
        `;
      return;
    }

    tbody.innerHTML = transactions
      .map(
        (t) => `
        <tr>
            <td>${formatDate(t.date)}</td>
            <td>
                <span class="fw-medium">${escapeHtml(t.description)}</span>
            </td>
            <td>
                <span class="badge bg-light text-dark">
                    ${escapeHtml(t.category_name || "Uncategorized")}
                </span>
            </td>
            <td>
                <small class="text-muted">
                    ${escapeHtml(
                      t.from_account_name || t.to_account_name || ""
                    )}
                </small>
            </td>
            <td class="text-end ${
              t.type === "income" ? "text-success" : "text-danger"
            } fw-bold">
                ${t.type === "income" ? "+" : "-"}${formatCurrency(t.amount)}
            </td>
        </tr>
    `
      )
      .join("");
  }

  // Load filter options
  function loadFilterOptions() {
    // Load accounts
    fetch("/api/v1/accounts")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const select = $("#accountFilter");
          data.data.forEach((account) => {
            select.append(
              `<option value="${account.id}">${escapeHtml(
                account.name
              )}</option>`
            );
          });
        }
      });

    // Load categories
    fetch("/api/v1/categories")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const select = $("#categoryFilter");
          data.data.forEach((category) => {
            select.append(
              `<option value="${category.id}">${escapeHtml(
                category.name
              )}</option>`
            );
          });
        }
      });
  }

  // Apply filters
  function applyFilters() {
    loadDashboardData();
  }

  // Refresh dashboard
  function refreshDashboard() {
    loadDashboardData();
    Swal.fire({
      icon: "success",
      title: "Refreshed",
      text: "Dashboard data has been updated",
      timer: 1500,
      showConfirmButton: false,
    });
  }

  // Format helpers
  function formatCurrency(amount) {
    return new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
    }).format(amount);
  }

  function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString("en-US", {
      year: "numeric",
      month: "short",
      day: "numeric",
    });
  }

  function escapeHtml(unsafe) {
    if (!unsafe) return "";
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>
{% endblock %}
