<!-- app/templates/updates/index.html -->
{% extends "base.html" %} {% block title %}System Updates - {{ super() }}{% endblock %} {% block
content %}
<div class="updates-page">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3"><i class="bi bi-arrow-repeat text-primary"></i> System Updates</h1>
    <div class="btn-group">
      <button type="button" class="btn btn-primary" onclick="checkForUpdates()">
        <i class="bi bi-cloud-download"></i> Check for Updates
      </button>
      <button type="button" class="btn btn-outline-secondary" onclick="viewChangelog()">
        <i class="bi bi-clock-history"></i> View Changelog
      </button>
    </div>
  </div>

  <!-- Current Version Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-primary text-white">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="h4 mb-2">Expense Tracker System</h2>
              <div class="d-flex align-items-center gap-3 mb-2">
                <span class="badge bg-white text-primary fs-6 px-3 py-2">
                  Version {{ app_version }}
                </span>
                <span class="text-white-50">
                  <i class="bi bi-calendar"></i>
                  Released January 15, 2024
                </span>
              </div>
              <p class="mb-0 text-white-50">
                <i class="bi bi-tag"></i>
                {{ update_status|default('You are running the latest version') }}
              </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
              <i class="bi bi-calculator display-1 text-white-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Status Cards -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="icon-circle bg-success bg-opacity-10 me-3">
              <i class="bi bi-check-circle text-success fs-4"></i>
            </div>
            <div>
              <h6 class="mb-0">System Status</h6>
              <small class="text-muted" id="systemStatus">Operational</small>
            </div>
          </div>
          <div class="mt-3">
            <div class="d-flex justify-content-between mb-2">
              <span>Uptime</span>
              <span class="fw-bold" id="uptime">99.9%</span>
            </div>
            <div class="progress" style="height: 6px">
              <div class="progress-bar bg-success" style="width: 99.9%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="icon-circle bg-info bg-opacity-10 me-3">
              <i class="bi bi-box-seam text-info fs-4"></i>
            </div>
            <div>
              <h6 class="mb-0">Dependencies</h6>
              <small class="text-muted" id="depsStatus">All up to date</small>
            </div>
          </div>
          <div class="mt-3">
            <div id="dependenciesList" class="small">
              <!-- Dynamic dependencies -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="icon-circle bg-warning bg-opacity-10 me-3">
              <i class="bi bi-shield-check text-warning fs-4"></i>
            </div>
            <div>
              <h6 class="mb-0">Security</h6>
              <small class="text-muted" id="securityStatus">No issues found</small>
            </div>
          </div>
          <div class="mt-3">
            <div class="d-flex justify-content-between mb-2">
              <span>Last security scan</span>
              <span class="fw-bold" id="lastScan">Today</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Vulnerabilities</span>
              <span class="fw-bold text-success" id="vulnerabilities">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Changelog Timeline -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-transparent">
          <h5 class="card-title mb-0"><i class="bi bi-clock-history"></i> Version History</h5>
        </div>
        <div class="card-body">
          <div class="timeline" id="changelogTimeline">
            <!-- Version 1.0.0 -->
            <div class="timeline-item active">
              <div class="timeline-badge bg-primary">
                <i class="bi bi-star-fill"></i>
              </div>
              <div class="timeline-content">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="mb-0">
                    Version 1.0.0
                    <span class="badge bg-success ms-2">Current</span>
                  </h6>
                  <small class="text-muted">January 15, 2024</small>
                </div>
                <span class="badge bg-primary mb-2">Major Release</span>
                <ul class="mb-0">
                  <li>Complete expense tracking system with Flask backend</li>
                  <li>Interactive dashboard with real-time charts</li>
                  <li>Transaction management (CRUD operations)</li>
                  <li>Account management with balance tracking</li>
                  <li>Budget planning and progress monitoring</li>
                  <li>Category organization with default categories</li>
                  <li>Comprehensive filtering system on all pages</li>
                  <li>Export functionality (CSV, JSON, Excel)</li>
                  <li>RESTful API with full documentation</li>
                  <li>Dark/Light theme support</li>
                  <li>Responsive design for all devices</li>
                  <li>Docker containerization</li>
                  <li>MongoDB database integration</li>
                  <li>Comprehensive logging system</li>
                </ul>
              </div>
            </div>

            <!-- Beta Versions -->
            <div class="timeline-item">
              <div class="timeline-badge bg-secondary">
                <i class="bi bi-flask"></i>
              </div>
              <div class="timeline-content">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="mb-0">Version 0.9.0</h6>
                  <small class="text-muted">December 20, 2023</small>
                </div>
                <span class="badge bg-secondary mb-2">Beta</span>
                <ul class="mb-0">
                  <li>Initial beta release</li>
                  <li>Core transaction functionality</li>
                  <li>Basic account management</li>
                  <li>Simple budget tracking</li>
                </ul>
              </div>
            </div>

            <div class="timeline-item">
              <div class="timeline-badge bg-secondary">
                <i class="bi bi-flask"></i>
              </div>
              <div class="timeline-content">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="mb-0">Version 0.8.0</h6>
                  <small class="text-muted">December 1, 2023</small>
                </div>
                <span class="badge bg-secondary mb-2">Alpha</span>
                <ul class="mb-0">
                  <li>First alpha release</li>
                  <li>Proof of concept</li>
                  <li>Basic UI components</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Future Roadmap -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-transparent">
          <h5 class="card-title mb-0"><i class="bi bi-map"></i> Development Roadmap</h5>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-4">
              <div class="text-center p-3 border rounded h-100">
                <div class="icon-circle bg-warning bg-opacity-10 mb-3">
                  <i class="bi bi-person-plus text-warning fs-3"></i>
                </div>
                <h6>Q1 2024</h6>
                <span class="badge bg-warning mb-2">In Development</span>
                <ul class="text-start small">
                  <li>User authentication</li>
                  <li>Multi-user support</li>
                  <li>Data import from CSV</li>
                </ul>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center p-3 border rounded h-100">
                <div class="icon-circle bg-info bg-opacity-10 mb-3">
                  <i class="bi bi-arrow-repeat text-info fs-3"></i>
                </div>
                <h6>Q2 2024</h6>
                <span class="badge bg-info mb-2">Planned</span>
                <ul class="text-start small">
                  <li>Recurring transactions</li>
                  <li>Email notifications</li>
                  <li>Advanced analytics</li>
                </ul>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center p-3 border rounded h-100">
                <div class="icon-circle bg-success bg-opacity-10 mb-3">
                  <i class="bi bi-phone text-success fs-3"></i>
                </div>
                <h6>Q3 2024</h6>
                <span class="badge bg-success mb-2">Future</span>
                <ul class="text-start small">
                  <li>Mobile app</li>
                  <li>Bank API integration</li>
                  <li>Multi-currency support</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- System Requirements -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-transparent">
          <h5 class="card-title mb-0"><i class="bi bi-cpu"></i> System Requirements</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="mb-3">Server Requirements</h6>
              <table class="table table-sm">
                <tr>
                  <td>Python</td>
                  <td>3.9 or higher</td>
                  <td><i class="bi bi-check-circle text-success"></i></td>
                </tr>
                <tr>
                  <td>MongoDB</td>
                  <td>6.0 or higher</td>
                  <td><i class="bi bi-check-circle text-success"></i></td>
                </tr>
                <tr>
                  <td>RAM</td>
                  <td>2GB minimum</td>
                  <td><i class="bi bi-check-circle text-success"></i></td>
                </tr>
                <tr>
                  <td>Disk Space</td>
                  <td>1GB minimum</td>
                  <td><i class="bi bi-check-circle text-success"></i></td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6 class="mb-3">Client Requirements</h6>
              <table class="table table-sm">
                <tr>
                  <td>Browser</td>
                  <td>Chrome 90+, Firefox 88+, Safari 14+</td>
                  <td><i class="bi bi-check-circle text-success"></i></td>
                </tr>
                <tr>
                  <td>JavaScript</td>
                  <td>Enabled</td>
                  <td><i class="bi bi-check-circle text-success"></i></td>
                </tr>
                <tr>
                  <td>Screen Resolution</td>
                  <td>1024x768 or higher</td>
                  <td><i class="bi bi-check-circle text-success"></i></td>
                </tr>
                <tr>
                  <td>Internet</td>
                  <td>Broadband connection</td>
                  <td><i class="bi bi-check-circle text-success"></i></td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .timeline {
    position: relative;
    padding-left: 3rem;
  }

  .timeline::before {
    content: '';
    position: absolute;
    left: 1rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
  }

  .timeline-item {
    position: relative;
    margin-bottom: 2rem;
  }

  .timeline-badge {
    position: absolute;
    left: -2rem;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    z-index: 1;
  }

  .timeline-content {
    padding-left: 1rem;
  }

  .timeline-item.active .timeline-content h6 {
    color: var(--primary-color);
    font-weight: bold;
  }

  [data-theme='dark'] .timeline::before {
    background: #495057;
  }

  .icon-circle {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    loadUpdateInfo();
    loadDependencies();
  });

  function loadUpdateInfo() {
    fetch('/api/v1/updates/check')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update version info
          const info = data.data;
          document.getElementById('systemStatus').textContent = info.updates_available
            ? 'Update Available'
            : 'Up to Date';
          document.getElementById('lastScan').textContent = formatDate(info.last_checked);
        }
      });
  }

  function loadDependencies() {
    fetch('/api/v1/updates/dependencies')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const deps = data.data.slice(0, 5);
          const container = document.getElementById('dependenciesList');

          container.innerHTML = deps
            .map(
              d => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${escapeHtml(d.name)}</span>
                        <span class="${d.up_to_date ? 'text-success' : 'text-warning'}">
                            ${d.installed}
                            ${!d.up_to_date ? ' â†’ ' + d.required : ''}
                        </span>
                    </div>
                `
            )
            .join('');

          const outdated = data.data.filter(d => !d.up_to_date).length;
          document.getElementById('depsStatus').textContent =
            outdated > 0 ? `${outdated} updates available` : 'All up to date';
        }
      });
  }

  function checkForUpdates() {
    Swal.fire({
      title: 'Checking for Updates',
      html: 'Please wait...',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();

        fetch('/api/v1/updates/check')
          .then(response => response.json())
          .then(data => {
            if (data.data.updates_available) {
              Swal.fire({
                title: 'Update Available!',
                html: `Version ${data.data.latest_version} is available`,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Update Now',
                cancelButtonText: 'Later'
              }).then(result => {
                if (result.isConfirmed) {
                  performUpdate(data.data.latest_version);
                }
              });
            } else {
              Swal.fire({
                title: 'No Updates',
                text: 'You are running the latest version',
                icon: 'success',
                timer: 2000
              });
            }
          });
      }
    });
  }

  function performUpdate(version) {
    Swal.fire({
      title: 'Updating System',
      html: 'Installing version ' + version + '...',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();

        fetch('/updates/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ version: version })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              Swal.fire({
                title: 'Update Complete!',
                text: data.message,
                icon: 'success'
              }).then(() => {
                location.reload();
              });
            } else {
              Swal.fire('Error', data.error, 'error');
            }
          });
      }
    });
  }

  function viewChangelog() {
    Swal.fire({
      title: 'Changelog',
      html: `
            <div class="text-start" style="max-height: 400px; overflow-y: auto;">
                <h6>Version 1.0.0 (2024-01-15)</h6>
                <ul class="small">
                    <li>Initial release</li>
                    <li>Complete expense tracking system</li>
                    <li>Interactive dashboard with charts</li>
                    <li>Transaction management</li>
                    <li>Account management</li>
                    <li>Budget planning</li>
                    <li>Category organization</li>
                    <li>Export functionality</li>
                    <li>RESTful API</li>
                </ul>
            </div>
        `,
      width: '600px'
    });
  }
</script>
{% endblock %}
