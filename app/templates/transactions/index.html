<!-- app/templates/transactions/index.html -->
{% extends "base.html" %} {% block title %}Transactions - {{ super() }}{% endblock %} {% block
content %}
<div class="transactions-page">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3"><i class="bi bi-arrow-left-right text-primary"></i> Transactions</h1>
    <div class="btn-group">
      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#addTransactionModal"
      >
        <i class="bi bi-plus-circle"></i> Add Transaction
      </button>
      <button
        type="button"
        class="btn btn-outline-primary"
        data-bs-toggle="collapse"
        data-bs-target="#filtersSection"
      >
        <i class="bi bi-funnel"></i> Filters
      </button>
      <button type="button" class="btn btn-outline-secondary" onclick="exportData('csv')">
        <i class="bi bi-download"></i> Export
      </button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="collapse show mb-4" id="filtersSection">
    <div class="card filter-card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Date Range</label>
            <input
              type="text"
              class="form-control"
              id="dateRange"
              placeholder="Select date range"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label">Type</label>
            <select class="form-select" id="typeFilter">
              <option value="">All Types</option>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
              <option value="transfer">Transfer</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Category</label>
            <select class="form-select" id="categoryFilter">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Account</label>
            <select class="form-select" id="accountFilter">
              <option value="">All Accounts</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Search</label>
            <input
              type="text"
              class="form-control"
              id="searchFilter"
              placeholder="Description..."
            />
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <button class="btn btn-primary" onclick="applyFilters()">
              <i class="bi bi-search"></i> Apply Filters
            </button>
            <button class="btn btn-outline-secondary" onclick="resetFilters()">
              <i class="bi bi-eraser"></i> Clear
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle" id="transactionsTable">
          <thead>
            <tr>
              <th width="50">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="selectAll" />
                </div>
              </th>
              <th>Date</th>
              <th>Description</th>
              <th>Category</th>
              <th>Account</th>
              <th class="text-end">Amount</th>
              <th>Tags</th>
              <th width="100">Actions</th>
            </tr>
          </thead>
          <tbody id="transactionsTableBody">
            <!-- Dynamic content -->
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted" id="tableInfo"></div>
        <nav aria-label="Page navigation">
          <ul class="pagination" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add New Transaction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="transactionForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Transaction Type *</label>
              <select class="form-select" name="type" id="transactionType" required>
                <option value="">Select Type</option>
                <option value="income">Income</option>
                <option value="expense">Expense</option>
                <option value="transfer">Transfer</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Date *</label>
              <input type="date" class="form-control" name="date" id="transactionDate" required />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Amount *</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input
                  type="number"
                  class="form-control"
                  name="amount"
                  step="0.01"
                  min="0.01"
                  required
                />
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Category *</label>
              <select class="form-select" name="category_id" id="categorySelect" required>
                <option value="">Select Category</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3" id="fromAccountField">
              <label class="form-label">From Account</label>
              <select class="form-select" name="from_account_id">
                <option value="">Select Account</option>
              </select>
            </div>
            <div class="col-md-6 mb-3" id="toAccountField">
              <label class="form-label">To Account</label>
              <select class="form-select" name="to_account_id">
                <option value="">Select Account</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Description *</label>
            <input type="text" class="form-control" name="description" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Tags</label>
            <input
              type="text"
              class="form-control"
              name="tags"
              placeholder="Comma-separated tags"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveTransaction()">
          Save Transaction
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTransactionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Transaction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editTransactionForm">
          <input type="hidden" name="id" id="editTransactionId" />
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Transaction Type *</label>
              <select class="form-select" name="type" id="editTransactionType" required>
                <option value="">Select Type</option>
                <option value="income">Income</option>
                <option value="expense">Expense</option>
                <option value="transfer">Transfer</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Date *</label>
              <input
                type="date"
                class="form-control"
                name="date"
                id="editTransactionDate"
                required
              />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Amount *</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input
                  type="number"
                  class="form-control"
                  name="amount"
                  id="editTransactionAmount"
                  step="0.01"
                  min="0.01"
                  required
                />
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Category *</label>
              <select class="form-select" name="category_id" id="editCategorySelect" required>
                <option value="">Select Category</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3" id="editFromAccountField">
              <label class="form-label">From Account</label>
              <select class="form-select" name="from_account_id" id="editFromAccount">
                <option value="">Select Account</option>
              </select>
            </div>
            <div class="col-md-6 mb-3" id="editToAccountField">
              <label class="form-label">To Account</label>
              <select class="form-select" name="to_account_id" id="editToAccount">
                <option value="">Select Account</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Description *</label>
            <input
              type="text"
              class="form-control"
              name="description"
              id="editTransactionDescription"
              required
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Tags</label>
            <input
              type="text"
              class="form-control"
              name="tags"
              id="editTransactionTags"
              placeholder="Comma-separated tags"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateTransaction()">Update</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">
          <i class="bi bi-exclamation-triangle"></i> Confirm Delete
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this transaction? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentPage = 1;
  let totalPages = 1;
  let deleteId = null;

  document.addEventListener('DOMContentLoaded', function () {
    // Initialize date picker
    flatpickr('#dateRange', {
      mode: 'range',
      dateFormat: 'Y-m-d',
      defaultDate: [new Date(new Date().setDate(1)), new Date()]
    });

    // Load initial data
    loadTransactions();
    loadFilterOptions();

    // Setup event listeners
    document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
    document.getElementById('transactionType').addEventListener('change', updateAccountFields);
    document
      .getElementById('editTransactionType')
      .addEventListener('change', editUpdateAccountFields);

    document
      .querySelector('select[name="from_account_id"]')
      .addEventListener('change', validateAccountSelection);
    document
      .querySelector('select[name="to_account_id"]')
      .addEventListener('change', validateAccountSelection);
  });

  function loadTransactions() {
    const params = new URLSearchParams({
      page: currentPage,
      per_page: 20
    });

    // Add filters
    const dateRange = document.getElementById('dateRange').value;
    if (dateRange) {
      const [start, end] = dateRange.split(' to ');
      params.append('start_date', start);
      params.append('end_date', end);
    }

    const type = document.getElementById('typeFilter').value;
    if (type) params.append('type', type);

    const category = document.getElementById('categoryFilter').value;
    if (category) params.append('category_id', category);

    const account = document.getElementById('accountFilter').value;
    if (account) params.append('account_id', account);

    const search = document.getElementById('searchFilter').value;
    if (search) params.append('search', search);

    fetch(`/api/v1/transactions/data?${params}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderTransactions(data.data);
          updatePagination(data.pagination);
        }
      })
      .catch(error => console.error('Error loading transactions:', error));
  }

  function renderTransactions(transactions) {
    const tbody = document.getElementById('transactionsTableBody');

    if (transactions.length === 0) {
      tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-5">
                    <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                    <span class="text-muted">No transactions found</span>
                </td>
            </tr>
        `;
      return;
    }

    tbody.innerHTML = transactions
      .map(
        t => `
        <tr>
            <td>
                <div class="form-check">
                    <input class="form-check-input transaction-checkbox" type="checkbox" value="${
                      t.id
                    }">
                </div>
            </td>
            <td>${formatDate(t.date)}</td>
            <td>
                <span class="fw-medium">${escapeHtml(t.description)}</span>
                ${t.is_reconciled ? '<span class="badge bg-success ms-2">Reconciled</span>' : ''}
            </td>
            <td>
                <span class="badge bg-light text-dark">
                    ${escapeHtml(t.category_name || 'Uncategorized')}
                </span>
            </td>
            <td>
                <small class="text-muted">
                    ${t.from_account_name ? escapeHtml(t.from_account_name) : ''}
                    ${t.from_account_name && t.to_account_name ? ' â†’ ' : ''}
                    ${t.to_account_name ? escapeHtml(t.to_account_name) : ''}
                </small>
            </td>
            <td class="text-end ${t.type === 'income' ? 'text-success' : 'text-danger'} fw-bold">
                ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
            </td>
            <td>
                ${
                  t.tags && t.tags.length > 0
                    ? t.tags
                        .map(
                          tag => `<span class="badge bg-secondary me-1">${escapeHtml(tag)}</span>`
                        )
                        .join('')
                    : '-'
                }
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editTransaction('${t.id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="confirmDelete('${t.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `
      )
      .join('');

    document.getElementById('tableInfo').innerHTML = `Showing ${transactions.length} of ${
      totalPages * 20
    }+ transactions`;
  }

  function updatePagination(pagination) {
    currentPage = pagination.page;
    totalPages = pagination.pages;

    const paginationEl = document.getElementById('pagination');
    let html = '';

    // Previous button
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
    </li>`;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>`;
      } else if (i === currentPage - 3 || i === currentPage + 3) {
        html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      }
    }

    // Next button
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
    </li>`;

    paginationEl.innerHTML = html;
  }

  function changePage(page) {
    if (page >= 1 && page <= totalPages) {
      currentPage = page;
      loadTransactions();
    }
  }

  function loadFilterOptions() {
    // Load categories
    fetch('/api/v1/categories')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const filterSelect = document.getElementById('categoryFilter');
          const formSelect = document.getElementById('categorySelect');
          const editFormSelect = document.getElementById('editCategorySelect');

          data.data.forEach(category => {
            filterSelect.append(new Option(category.name, category.id));
            if (category.type === 'expense' || category.type === 'income') {
              formSelect.append(new Option(category.name, category.id));
              editFormSelect.append(new Option(category.name, category.id));
            }
          });
        }
      });

    // Load accounts
    fetch('/api/v1/accounts')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const filterSelect = document.getElementById('accountFilter');
          const fromSelect = document.querySelector('select[name="from_account_id"]');
          const toSelect = document.querySelector('select[name="to_account_id"]');
          const editFromSelect = document.getElementById('editFromAccount');
          const editToSelect = document.getElementById('editToAccount');

          data.data.forEach(account => {
            filterSelect.append(new Option(account.name, account.id));
            fromSelect.append(new Option(account.name, account.id));
            toSelect.append(new Option(account.name, account.id));
            editFromSelect.append(new Option(account.name, account.id));
            editToSelect.append(new Option(account.name, account.id));
          });
        }
      });
  }

  function updateAccountFields() {
    const type = document.getElementById('transactionType').value;
    const fromField = document.getElementById('fromAccountField');
    const toField = document.getElementById('toAccountField');

    if (type === 'income') {
      fromField.style.display = 'none';
      toField.style.display = 'block';
      document.querySelector('select[name="from_account_id"]').removeAttribute('required');
      document.querySelector('select[name="to_account_id"]').setAttribute('required', 'required');
    } else if (type === 'expense') {
      fromField.style.display = 'block';
      toField.style.display = 'none';
      document.querySelector('select[name="from_account_id"]').setAttribute('required', 'required');
      document.querySelector('select[name="to_account_id"]').removeAttribute('required');
    } else if (type === 'transfer') {
      fromField.style.display = 'block';
      toField.style.display = 'block';
      document.querySelector('select[name="from_account_id"]').setAttribute('required', 'required');
      document.querySelector('select[name="to_account_id"]').setAttribute('required', 'required');
      validateAccountSelection();
    }
  }

  function validateAccountSelection() {
    const fromSelect = document.querySelector('select[name="from_account_id"]');
    const toSelect = document.querySelector('select[name="to_account_id"]');
    const type = document.getElementById('transactionType').value;

    if (type === 'transfer' && fromSelect && toSelect) {
      // Remove options from 'to' that are selected in 'from'
      const fromValue = fromSelect.value;
      Array.from(toSelect.options).forEach(option => {
        if (option.value && option.value === fromValue) {
          option.disabled = true;
        } else {
          option.disabled = false;
        }
      });

      // If currently selected 'to' is disabled, clear it
      if (toSelect.value === fromValue) {
        toSelect.value = '';
      }
    }
  }

  function saveTransaction() {
    const form = document.getElementById('transactionForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Process tags
    if (data.tags) {
      data.tags = data.tags.split(',').map(tag => tag.trim());
    } else {
      data.tags = [];
    }

    if (data.amount) {
      // Remove any non-numeric characters except decimal point
      const amountStr = data.amount.toString().replace(/[^0-9.-]/g, '');
      data.amount = parseFloat(amountStr);
    }

    // Remove empty fields
    if (!data.from_account_id) delete data.from_account_id;
    if (!data.to_account_id) delete data.to_account_id;

    fetch('/api/v1/transactions', {
      // Changed from /api/v1/transactions/create
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Success', 'Transaction added successfully', 'success');
          $('#addTransactionModal').modal('hide');
          form.reset();
          loadTransactions();
        } else {
          Swal.fire('Error', data.error, 'error');
        }
      })
      .catch(error => Swal.fire('Error', 'Failed to save transaction', 'error'));
  }

  function editUpdateAccountFields() {
    const type = document.getElementById('editTransactionType').value;
    const fromField = document.getElementById('editFromAccountField');
    const toField = document.getElementById('editToAccountField');

    if (type === 'income') {
      fromField.style.display = 'none';
      toField.style.display = 'block';
      document.getElementById('editFromAccount').removeAttribute('required');
      document.getElementById('editToAccount').setAttribute('required', 'required');
    } else if (type === 'expense') {
      fromField.style.display = 'block';
      toField.style.display = 'none';
      document.getElementById('editFromAccount').setAttribute('required', 'required');
      document.getElementById('editToAccount').removeAttribute('required');
    } else if (type === 'transfer') {
      fromField.style.display = 'block';
      toField.style.display = 'block';
      document.getElementById('editFromAccount').setAttribute('required', 'required');
      document.getElementById('editToAccount').setAttribute('required', 'required');
      editValidateAccountSelection();
    }
  }

  function editValidateAccountSelection() {
    const fromSelect = document.getElementById('editFromAccount');
    const toSelect = document.getElementById('editToAccount');
    const type = document.getElementById('editTransactionType').value;

    if (type === 'transfer' && fromSelect && toSelect) {
      const fromValue = fromSelect.value;
      Array.from(toSelect.options).forEach(option => {
        if (option.value && option.value === fromValue) {
          option.disabled = true;
        } else {
          option.disabled = false;
        }
      });

      if (toSelect.value === fromValue) {
        toSelect.value = '';
      }
    }
  }

  function updateTransaction() {
    const form = document.getElementById('editTransactionForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const transactionId = document.getElementById('editTransactionId').value;

    // Process tags
    if (data.tags) {
      data.tags = data.tags.split(',').map(tag => tag.trim());
    } else {
      data.tags = [];
    }

    // Remove empty fields
    if (!data.from_account_id) delete data.from_account_id;
    if (!data.to_account_id) delete data.to_account_id;

    fetch(`/api/v1/transactions/${transactionId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Success', 'Transaction updated successfully', 'success');
          $('#editTransactionModal').modal('hide');
          loadTransactions();
        } else {
          Swal.fire('Error', data.error, 'error');
        }
      })
      .catch(error => Swal.fire('Error', 'Failed to update transaction', 'error'));
  }

  function editTransaction(id) {
    fetch(`/api/v1/transactions/${id}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const transaction = data.data;

          // Set basic fields
          document.getElementById('editTransactionId').value = transaction.id;
          document.getElementById('editTransactionType').value = transaction.type || '';

          // Simpler but still comprehensive date handling
          let dateValue = '';
          if (transaction.date) {
            try {
              // Convert to Date object regardless of input type
              let dateObj;

              if (typeof transaction.date === 'string') {
                dateObj = new Date(transaction.date);
              } else if (
                transaction.date &&
                typeof transaction.date === 'object' &&
                transaction.date.$date
              ) {
                // MongoDB ISODate format
                dateObj = new Date(transaction.date.$date);
              } else if (typeof transaction.date === 'object') {
                // Date object or MongoDB Date
                dateObj = new Date(transaction.date);
              } else if (typeof transaction.date === 'number') {
                // Unix timestamp
                dateObj = new Date(transaction.date);
              }

              if (dateObj && !isNaN(dateObj.getTime())) {
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                dateValue = `${year}-${month}-${day}`;
              }
            } catch (e) {
              console.error('Date parsing error:', e);
            }
          }

          document.getElementById('editTransactionDate').value = dateValue;

          document.getElementById('editTransactionAmount').value = transaction.amount || 0;
          document.getElementById('editTransactionDescription').value =
            transaction.description || '';
          document.getElementById('editCategorySelect').value = transaction.category_id || '';

          // Set account fields
          if (transaction.from_account_id) {
            document.getElementById('editFromAccount').value = transaction.from_account_id;
          } else {
            document.getElementById('editFromAccount').value = '';
          }

          if (transaction.to_account_id) {
            document.getElementById('editToAccount').value = transaction.to_account_id;
          } else {
            document.getElementById('editToAccount').value = '';
          }

          // Set tags
          if (transaction.tags && Array.isArray(transaction.tags) && transaction.tags.length > 0) {
            document.getElementById('editTransactionTags').value = transaction.tags.join(', ');
          } else {
            document.getElementById('editTransactionTags').value = '';
          }

          // Update field visibility based on type
          editUpdateAccountFields();

          // Show modal
          $('#editTransactionModal').modal('show');
        } else {
          Swal.fire('Error', data.error || 'Failed to load transaction', 'error');
        }
      })
      .catch(error => {
        console.error('Error loading transaction:', error);
        Swal.fire('Error', 'Failed to load transaction details', 'error');
      });
  }

  function confirmDelete(id) {
    deleteId = id;
    $('#deleteModal').modal('show');
  }

  document.getElementById('confirmDelete').addEventListener('click', function () {
    if (deleteId) {
      fetch(`/api/v1/transactions/${deleteId}`, {
        method: 'DELETE'
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Deleted', 'Transaction deleted successfully', 'success');
            $('#deleteModal').modal('hide');
            loadTransactions();
          } else {
            Swal.fire('Error', data.error, 'error');
          }
        });
    }
  });

  function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox');
    const selectAll = document.getElementById('selectAll');
    checkboxes.forEach(cb => (cb.checked = selectAll.checked));
  }

  function applyFilters() {
    currentPage = 1;
    loadTransactions();
  }

  function resetFilters() {
    document.getElementById('typeFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('accountFilter').value = '';
    document.getElementById('searchFilter').value = '';
    document.getElementById('dateRange').value = '';
    applyFilters();
  }
</script>
{% endblock %}
